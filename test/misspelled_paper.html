<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>11+ VR: Spelling Master & PDF Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --exam-blue: #1e3a8a; --paper-bg: #ffffff; --correct: #10b981; --wrong: #ef4444; }
        
        /* Á∂≤È†ÅÈ°ØÁ§∫Ê®£Âºè */
        body { font-family: "Times New Roman", serif; background-color: #f1f5f9; margin: 0; padding: 10px; color: #1e293b; }
        .container { max-width: 850px; margin: auto; background: var(--paper-bg); padding: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        .no-print-area { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e2e8f0; }
        
        #timerDisplay { position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 10px 20px; border-radius: 50px; font-weight: bold; display: none; z-index: 1000; }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 8px; color: var(--exam-blue); }
        .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1.1em; box-sizing: border-box; }
        
        .day-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; background: white; padding: 15px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .btn-start { width: 100%; padding: 18px; background: var(--exam-blue); color: white; border: none; border-radius: 10px; font-size: 1.3em; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        
        /* ËÄÉÈ°åÊ®£Âºè */
        .question-block { margin-bottom: 40px; padding: 20px; border-bottom: 1px solid #e2e8f0; page-break-inside: avoid; }
        .spelling-word { font-size: 2.5em; letter-spacing: 10px; font-family: 'Courier New', monospace; text-align: center; margin: 20px 0; }
        .blank { border-bottom: 3px solid #000; display: inline-block; min-width: 35px; text-align: center; }
        
        .letter-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; }
        .letter-btn { background: #fff; border: 2px solid #cbd5e1; font-size: 1.3em; width: 55px; height: 55px; cursor: pointer; border-radius: 10px; font-weight: bold; }
        .letter-btn.used { opacity: 0.2; pointer-events: none; }
        
        /* ÂàóÂç∞Â∞àÁî®Ê®£Âºè */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; width: 100%; max-width: 100%; }
            .no-print-area, #timerDisplay, .letter-pool, .control-btns, .btn-start, #overlay { display: none !important; }
            .question-block { border-bottom: 1px solid #ccc; padding: 15px 0; }
            .print-only-options { display: block !important; margin-top: 15px; font-size: 1.2em; }
            .spelling-word { font-size: 2em; letter-spacing: 15px; }
            h1 { font-size: 1.5em; text-align: center; }
        }
        
        .print-only-options { display: none; }
        .option-box { display: inline-block; border: 1px solid #000; width: 25px; height: 25px; margin-left: 10px; vertical-align: middle; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 9999; }
    </style>
</head>
<body>

<div id="timerDisplay">Time Left: <span id="time">00:00</span></div>
<div id="overlay"><h2 id="statusText">Uploading Results...</h2><div id="progressText" style="font-size: 1.5em;">0 / 0</div></div>

<div class="container">
    <div id="setupArea" class="no-print-area">
        <h1>‚úçÔ∏è 11+ Spelling Master & PDF Generator</h1>
        
        <div class="input-group">
            <label>üë§ Student Name:</label>
            <input type="text" id="studentName" class="input-field" placeholder="Enter student name">
        </div>

        <div class="input-group">
            <label>üìÖ Select Days:</label>
            <div class="day-grid" id="daySelector">Loading vocabulary...</div>
        </div>

        <div class="input-group">
            <label>‚è±Ô∏è Exam Timer (Minutes):</label>
            <input type="number" id="examTimeLimit" class="input-field" placeholder="Leave empty for unlimited">
        </div>

        <button class="btn-start" id="generateBtn" onclick="prepareExam()" disabled>Please Wait...</button>
        <button class="btn-start" style="background:#64748b;" onclick="window.print()">üñ®Ô∏è Print Paper (PDF)</button>
    </div>

    <div id="examPaper"></div>
</div>

<script>
    const CSV_URL = "./csv/vocab.csv"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyNk4As8i9VDlQBoNijrSimSbO2j6Gf6zVv9dwwlU1XIGelKNNyJxdSDiouZU8j0BgiMg/exec"; 

    let rawData = [];
    let examData = [];
    let timerInterval;

    window.onload = loadCSV;

    function loadCSV() {
        Papa.parse(CSV_URL + "?v=" + new Date().getTime(), {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                rawData = results.data.map(row => {
                    let newRow = {};
                    for (let key in row) newRow[key.toLowerCase().trim()] = row[key];
                    return newRow;
                });
                const days = [...new Set(rawData.map(item => item.day))].filter(d => d).sort((a,b) => parseInt(a) - parseInt(b));
                document.getElementById('daySelector').innerHTML = days.map(d => `<label style="display:flex;align-items:center;font-size:14px;"><input type="checkbox" name="dayCheck" value="${d}" style="margin-right:5px;"> Day ${d}</label>`).join('');
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').innerText = "Start iPad Challenge";
            }
        });
    }

    function createSpellingQuestion(word) {
        if (!word || word.trim().length < 4) return null;
        const cleanWord = word.trim().toUpperCase();
        const hideCount = cleanWord.length > 7 ? 3 : 2;
        const startIdx = Math.floor((cleanWord.length - hideCount) / 2);
        
        let displayArr = cleanWord.split('');
        let missing = [];
        let blanksIdx = [];

        for(let i=0; i<hideCount; i++) {
            let idx = startIdx + i;
            missing.push(displayArr[idx]);
            displayArr[idx] = '_';
            blanksIdx.push(idx);
        }

        let pool = [...missing];
        const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        while(pool.length < missing.length + 4) {
            let r = alpha[Math.floor(Math.random()*26)];
            if(!pool.includes(r)) pool.push(r);
        }
        pool.sort(() => Math.random() - 0.5);

        return { original: cleanWord, display: displayArr, pool: pool, userEntry: [], blanksIdx: blanksIdx };
    }

    function prepareExam() {
        const selectedDays = Array.from(document.querySelectorAll('input[name="dayCheck"]:checked')).map(cb => cb.value);
        if (selectedDays.length === 0) return alert("Select days first!");

        let filtered = rawData.filter(item => selectedDays.includes(item.day));
        examData = filtered.map(item => createSpellingQuestion(item.word)).filter(q => q !== null);
        examData.sort(() => Math.random() - 0.5);

        renderExam();
        const mins = document.getElementById('examTimeLimit').value;
        if (mins > 0) startTimer(mins * 60);
        document.getElementById('setupArea').style.display = 'none';
    }

    function startTimer(seconds) {
        document.getElementById('timerDisplay').style.display = 'block';
        timerInterval = setInterval(() => {
            let m = Math.floor(seconds / 60), s = seconds % 60;
            document.getElementById('time').textContent = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            if (--seconds < 0) { clearInterval(timerInterval); submitExam(); }
        }, 1000);
    }

    function renderExam() {
        const paper = document.getElementById('examPaper');
        const student = document.getElementById('studentName').value || "Candidate";
        paper.innerHTML = `<h1 style="text-align:center;">11+ Spelling Practice Paper</h1>
                           <p style="text-align:center;">Candidate: __________________ &nbsp;&nbsp; Date: ${new Date().toLocaleDateString()}</p>`;
        
        examData.forEach((q, i) => {
            paper.innerHTML += `
                <div class="question-block" id="block-${i}">
                    <div style="font-weight:bold;">Question ${i+1}: Fill in the missing letters to complete the word.</div>
                    <div class="spelling-word" id="word-${i}">${q.display.map(c => c === '_' ? `<span class="blank">&nbsp;</span>` : c).join('')}</div>
                    
                    <div class="letter-pool" id="pool-${i}">
                        ${q.pool.map((l, li) => `<button class="letter-btn" onclick="addLetter(${i}, '${l}', ${li}, this)">${l}</button>`).join('')}
                    </div>

                    <div class="print-only-options">
                        Possible letters: <b>${q.pool.join(', ')}</b>
                        <div style="margin-top:10px;">Answer: ____________________</div>
                    </div>
                </div>`;
        });
        paper.innerHTML += `<button class="btn-start" style="background:#059669; margin-top:40px;" onclick="submitExam()">Finish and Submit</button>`;
    }

    function addLetter(qIdx, letter, poolIdx, btn) {
        const q = examData[qIdx];
        if (q.userEntry.length >= q.blanksIdx.length) return;
        q.userEntry.push({letter, poolIdx});
        btn.classList.add('used');
        updateWordDisplay(qIdx);
    }

    function updateWordDisplay(qIdx) {
        const q = examData[qIdx];
        let tempDisplay = [...q.display];
        q.userEntry.forEach((entry, i) => { tempDisplay[q.blanksIdx[i]] = `<span class="blank" style="color:var(--exam-blue)">${entry.letter}</span>`; });
        document.getElementById(`word-${qIdx}`).innerHTML = tempDisplay.join('');
    }

    async function submitExam() {
        clearInterval(timerInterval);
        document.getElementById('timerDisplay').style.display = 'none';
        document.getElementById('overlay').style.display = 'flex';
        const student = document.getElementById('studentName').value || "Manual Student";

        for (let i = 0; i < examData.length; i++) {
            const q = examData[i];
            let finalArr = [...q.display];
            q.userEntry.forEach((entry, idx) => { finalArr[q.blanksIdx[idx]] = entry.letter; });
            const userStr = finalArr.join('');
            const isCorrect = userStr === q.original;

            const payload = {
                student: student,
                submitDate: new Date().toLocaleString(),
                testType: "Misspelled",
                word: q.original,
                userAnswer: userStr,
                correctAnswer: q.original,
                status: isCorrect ? "‚úÖ Correct" : "‚ùå Incorrect"
            };

            try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }); } catch (e) {}
            document.getElementById('progressText').innerText = `${i+1} / ${examData.length}`;
        }
        document.getElementById('overlay').style.display = 'none';
        alert("Completed! Excellent work.");
        location.reload();
    }
</script>
</body>
</html>
