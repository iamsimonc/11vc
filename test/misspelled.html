<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>11+ VR: Spelling Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --exam-blue: #1e3a8a; --paper-bg: #ffffff; --correct: #10b981; --wrong: #ef4444; }
        body { font-family: "Times New Roman", serif; background-color: #f1f5f9; margin: 0; padding: 10px; color: #1e293b; }
        .container { max-width: 850px; margin: auto; background: var(--paper-bg); padding: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        .no-print { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e2e8f0; }
        #timerDisplay { position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 10px 20px; border-radius: 50px; font-family: Arial; font-weight: bold; display: none; z-index: 1000; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 8px; font-family: Arial; color: var(--exam-blue); }
        .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1.1em; box-sizing: border-box; }
        .day-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; background: white; padding: 15px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .day-item { display: flex; align-items: center; cursor: pointer; font-size: 14px; }
        .btn-start { width: 100%; padding: 18px; background: var(--exam-blue); color: white; border: none; border-radius: 10px; font-size: 1.3em; font-weight: bold; cursor: pointer; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 9999; }
        
        /* ÊãºÂ≠óÈ°åÂ∞àÂ±¨Ê®£Âºè */
        .spelling-word { font-size: 2.5em; letter-spacing: 8px; font-family: monospace; text-align: center; margin: 20px 0; color: #334155; }
        .blank { border-bottom: 4px solid var(--exam-blue); color: var(--accent); display: inline-block; min-width: 40px; }
        .letter-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; margin-top: 20px; }
        .letter-btn { background: #f1f5f9; border: 2px solid #cbd5e1; font-size: 1.5em; padding: 15px; width: 60px; height: 60px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        .letter-btn:active { background: #dbeafe; transform: scale(0.9); }
        .letter-btn.used { opacity: 0.3; pointer-events: none; }
        .control-btns { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .btn-small { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-undo { background: #94a3b8; color: white; }
    </style>
</head>
<body>

<div id="timerDisplay">Time Left: <span id="time">00:00</span></div>
<div id="overlay"><h2 id="statusText">Uploading results...</h2><div id="progressText" style="font-size: 1.5em;">0 / 0</div></div>

<div class="container">
    <div id="setupArea" class="no-print">
        <h1>‚úçÔ∏è 11+ Spelling Master (GL Mode)</h1>
        
        <div class="input-group">
            <label>üë§ Student Name:</label>
            <input type="text" id="studentName" class="input-field" placeholder="Enter student name">
        </div>

        <div class="input-group">
            <label>üìÖ Select Days (From vocab.csv):</label>
            <div style="margin-bottom: 10px;">
                <button onclick="toggleAll(true)">Select All</button>
                <button onclick="toggleAll(false)">Clear All</button>
            </div>
            <div class="day-grid" id="daySelector">Loading vocabulary...</div>
        </div>

        <div class="input-group">
            <label>‚è±Ô∏è Exam Timer:</label>
            <input type="number" id="examTimeLimit" class="input-field" placeholder="Minutes (Optional)">
            <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; cursor: pointer;">
                <input type="checkbox" id="showTimerCheck" checked style="width:18px; height:18px;"> Show timer on screen
            </label>
        </div>

        <button class="btn-start" id="generateBtn" onclick="prepareExam()" disabled>Waiting for data...</button>
    </div>

    <div id="examPaper"></div>
</div>

<script>
    const CSV_URL = "./csv/vocab.csv"; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxSUw-5tHjb07KxKea45gTRjyIRP0D3kUoRVjlB6Njmbtdnx1wEYrwffJOrvogPP1B1iw/exec"; 

    let rawData = [];
    let examData = [];
    let timerInterval;

    window.onload = loadCSV;

    function loadCSV() {
        Papa.parse(CSV_URL + "?v=" + new Date().getTime(), {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                rawData = results.data;
                const days = [...new Set(rawData.map(item => item.day))].filter(d => d).sort((a,b) => parseInt(a) - parseInt(b));
                document.getElementById('daySelector').innerHTML = days.map(d => `<label class="day-item"><input type="checkbox" name="dayCheck" value="${d}"> Day ${d}</label>`).join('');
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').innerText = "Start Spelling Challenge";
            }
        });
    }

    function toggleAll(s) { document.querySelectorAll('input[name="dayCheck"]').forEach(cb => cb.checked = s); }

    function prepareExam() {
        const student = document.getElementById('studentName').value.trim();
        const selectedDays = Array.from(document.querySelectorAll('input[name="dayCheck"]:checked')).map(cb => cb.value);
        if (!student || selectedDays.length === 0) return alert("Please enter name and select days!");

        let filtered = rawData.filter(item => selectedDays.includes(item.day));
        examData = filtered.map(item => createSpellingQuestion(item.word)).filter(q => q !== null);
        examData.sort(() => Math.random() - 0.5);

        document.getElementById('setupArea').style.display = 'none';
        const paper = document.getElementById('examPaper');
        const timeLimit = document.getElementById('examTimeLimit').value;
        const showTimer = document.getElementById('showTimerCheck').checked;

        paper.innerHTML = `<div style="text-align:center; padding:50px;">
            <h2>Spelling Readiness</h2>
            <p>Candidate: <b>${student}</b> | Questions: <b>${examData.length}</b></p>
            <button class="btn-start" onclick="startExam(${timeLimit}, ${showTimer})">GO!</button>
        </div>`;
    }

    // ÊãºÂØ´ÈÇèËºØÔºöÈÅÆËìãÂñÆÂ≠ó‰∏≠Èñì 2-3 ÂÄãÂ≠óÊØç
    function createSpellingQuestion(word) {
        if (!word || word.length < 4) return null;
        const wordArr = word.toUpperCase().split('');
        const hideCount = word.length > 6 ? 3 : 2;
        const startIdx = Math.floor(word.length / 2) - 1;
        
        let missing = [];
        let displayArr = [...wordArr];
        
        for(let i=0; i<hideCount; i++) {
            missing.push(wordArr[startIdx + i]);
            displayArr[startIdx + i] = '_';
        }

        // Â≠óÊØçÊ±†ÔºöÊ≠£Á¢∫Â≠óÊØç + 4 ÂÄãÈö®Ê©üÂ≠óÊØç
        let pool = [...missing];
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        while(pool.length < missing.length + 4) {
            let r = alphabet[Math.floor(Math.random()*26)];
            if(!pool.includes(r)) pool.push(r);
        }
        pool.sort(() => Math.random() - 0.5);

        return {
            original: word.toUpperCase(),
            display: displayArr,
            missing: missing,
            pool: pool,
            userEntry: [],
            blanksIdx: Array.from({length: hideCount}, (_, i) => startIdx + i)
        };
    }

    function startExam(mins, show) {
        renderExam();
        if (mins > 0) {
            let timer = mins * 60;
            const display = document.getElementById('time');
            if (show) document.getElementById('timerDisplay').style.display = 'block';
            timerInterval = setInterval(() => {
                let m = parseInt(timer / 60, 10), s = parseInt(timer % 60, 10);
                display.textContent = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                if (--timer < 0) { clearInterval(timerInterval); submitExam(); }
            }, 1000);
        }
    }

    function renderExam() {
        const paper = document.getElementById('examPaper');
        paper.innerHTML = `<h2 style="text-align:center;">11+ Spelling Challenge</h2>`;
        
        examData.forEach((q, i) => {
            paper.innerHTML += `
                <div class="question-block" id="block-${i}">
                    <div style="font-weight:bold; color:var(--exam-blue);">Question ${i+1}: Complete the word</div>
                    <div class="spelling-word" id="word-${i}">${renderWordWithBlanks(q)}</div>
                    <div class="letter-pool" id="pool-${i}">
                        ${q.pool.map((l, li) => `<button class="letter-btn" onclick="addLetter(${i}, '${l}', ${li}, this)">${l}</button>`).join('')}
                    </div>
                    <div class="control-btns">
                        <button class="btn-small btn-undo" onclick="undoLetter(${i})">Undo</button>
                    </div>
                </div>`;
        });
        paper.innerHTML += `<button class="btn-start" style="background:#059669; margin-top:40px;" onclick="submitExam()">Finish and Submit</button>`;
    }

    function renderWordWithBlanks(q) {
        return q.display.map(char => char === '_' ? `<span class="blank">_</span>` : char).join('');
    }

    function addLetter(qIdx, letter, poolIdx, btn) {
        const q = examData[qIdx];
        if (q.userEntry.length >= q.missing.length) return;
        
        q.userEntry.push({letter, poolIdx});
        btn.classList.add('used');
        
        // Êõ¥Êñ∞È°ØÁ§∫
        const currentBlankIdx = q.blanksIdx[q.userEntry.length - 1];
        let tempDisplay = [...q.display];
        q.userEntry.forEach((entry, i) => {
            tempDisplay[q.blanksIdx[i]] = `<span class="blank">${entry.letter}</span>`;
        });
        document.getElementById(`word-${qIdx}`).innerHTML = tempDisplay.join('');
    }

    function undoLetter(qIdx) {
        const q = examData[qIdx];
        if (q.userEntry.length === 0) return;
        
        const last = q.userEntry.pop();
        const btns = document.getElementById(`pool-${qIdx}`).querySelectorAll('.letter-btn');
        btns[last.poolIdx].classList.remove('used');
        
        let tempDisplay = [...q.display];
        q.userEntry.forEach((entry, i) => {
            tempDisplay[q.blanksIdx[i]] = `<span class="blank">${entry.letter}</span>`;
        });
        document.getElementById(`word-${qIdx}`).innerHTML = tempDisplay.join('');
    }

    async function submitExam() {
        clearInterval(timerInterval);
        document.getElementById('timerDisplay').style.display = 'none';
        document.getElementById('overlay').style.display = 'flex';
        const student = document.getElementById('studentName').value;

        for (let i = 0; i < examData.length; i++) {
            const q = examData[i];
            let finalWord = [...q.display];
            q.userEntry.forEach((entry, idx) => { finalWord[q.blanksIdx[idx]] = entry.letter; });
            const userString = finalWord.join('');
            const isCorrect = userString === q.original;

            const payload = {
                student: student,
                submitDate: new Date().toLocaleString(),
                testType: "Misspelled",
                word: q.original,
                userAnswer: userString,
                correctAnswer: q.original,
                status: isCorrect ? "‚úÖ Correct" : "‚ùå Incorrect"
            };

            try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }); } catch (e) {}
            document.getElementById('progressText').innerText = `${i+1} / ${examData.length}`;
        }
        
        document.getElementById('overlay').style.display = 'none';
        alert("Wonderful! You've completed the Spelling Challenge. Your dedication to perfection is what makes a true scholar. Click OK to finish.");
        location.reload();
    }
</script>
</body>
</html>
