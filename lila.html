<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lila 11+ VR Vocabulary</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --core: #55efc4; --elite: #fd79a8; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        .no-print { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #334155; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-right: 5px; transition: 0.3s; }
        .btn-audio { background: #4b5563; color: white; padding: 5px 10px; font-size: 0.8em; }
        .btn-record { background: #e74c3c; color: white; }
        .btn-play-rec { background: #f1c40f; color: black; }
        .btn-gen { background: var(--primary); color: white; }
        
        /* æ–°å¢é¸æ“‡å™¨æ¨£å¼ */
        .selection-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-top: 10px; }
        #checkbox-container { display: none; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; margin-top: 10px; max-height: 150px; overflow-y: auto; padding: 10px; background: #0f172a; border-radius: 8px; }
        .day-check { display: flex; align-items: center; gap: 3px; font-size: 0.9em; }

        .spell-area { background: #0f172a; padding: 20px; border-radius: 12px; border: 2px solid #334155; margin-top: 15px; }
        .answer-display { font-size: 2em; min-height: 1.2em; border-bottom: 3px solid var(--primary); margin-bottom: 20px; letter-spacing: 5px; color: #fff; font-family: monospace; }
        .letter-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .letter-btn { background: #334155; color: white; border: 2px solid #4b5563; padding: 10px 15px; font-size: 1.5em; border-radius: 8px; cursor: pointer; min-width: 45px; }
        .letter-btn:disabled { opacity: 0.3; cursor: default; }
        
        .vocab-card { background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 10px solid var(--primary); }
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
        .badge-core { background: var(--core); color: #000; }
        .badge-elite { background: var(--elite); color: #fff; }

        @media print {
            .no-print, .btn, .web-interactive-area, .btn-audio { display: none !important; }
            .vocab-card { border: 1px solid #000; color: black !important; background: white !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1>ğŸš€ Lila 11+ Vocabulary ç·´ç¿’ç³»çµ±</h1>
        
        <div class="selection-box">
            <div style="margin-bottom: 10px;">
                <label>é¸æ“‡æ¨¡å¼ï¼š</label>
                <select id="modeSelect" onchange="toggleModeUI()" style="padding:5px; border-radius:5px;">
                    <option value="single">å–®æ—¥æ¨¡å¼ (Day X)</option>
                    <option value="range">é€£é¸æ¨¡å¼ (Day 1 åˆ° Day X)</option>
                    <option value="multi">å¤šé¸æ¨¡å¼ (è‡ªé¸æ—¥å­)</option>
                </select>
            </div>

            <div id="ui-single-range">
                <label id="inputLabel">è¼¸å…¥å¤©æ•¸: </label>
                <input type="number" id="weekInput" value="1" style="width:60px; padding:8px; border-radius:5px; border:1px solid #ccc;">
            </div>

            <div id="ui-multi" style="display:none;">
                <button class="btn" style="background:#4b5563; font-size:0.8em;" onclick="toggleCheckboxArea()">ğŸ“‚ å±•é–‹/æ”¶èµ·æ—¥å­é¸æ“‡</button>
                <div id="checkbox-container">
                    </div>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-gen" onclick="generateVocab()">ğŸ”„ ç”Ÿæˆç”Ÿå­—æ¸…å–®</button>
                <button class="btn" style="background:#27ae60; color:white;" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ¸¬é©—å·</button>
            </div>
        </div>
    </div>

    <div id="mainDisplay"></div>
</div>

<script>
    const STUDENT_NAME = "Lila"; 
    const SCRIPT_URL = "YOUR_GOOGLE_SCRIPT_URL"; // è«‹å¡«å…¥ä½ çš„ Google Script URL
    let allVocab = [];
    let currentWords = [];
    let mediaRecorder;
    let audioChunks = {};
    let userAnswers = {};

    window.onload = function() {
        // ç”Ÿæˆå¤šé¸æ¨¡å¼çš„ Checkboxes (1-150å¤©)
        const container = document.getElementById('checkbox-container');
        for (let i = 1; i <= 150; i++) {
            container.innerHTML += `<div class="day-check"><input type="checkbox" class="day-cb" value="${i}"> ${i}</div>`;
        }

        Papa.parse("vocab.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                allVocab = results.data;
                console.log("Data Loaded:", allVocab);
            }
        });
    };

    function toggleModeUI() {
        const mode = document.getElementById('modeSelect').value;
        document.getElementById('ui-single-range').style.display = (mode === 'multi') ? 'none' : 'block';
        document.getElementById('ui-multi').style.display = (mode === 'multi') ? 'block' : 'none';
        document.getElementById('inputLabel').innerText = (mode === 'range') ? "Day 1 åˆ°: " : "è¼¸å…¥å¤©æ•¸: ";
    }

    function toggleCheckboxArea() {
        const container = document.getElementById('checkbox-container');
        container.style.display = (container.style.display === 'grid') ? 'none' : 'grid';
    }

    function generateVocab() {
        const mode = document.getElementById('modeSelect').value;
        const targetVal = parseInt(document.getElementById('weekInput').value);
        let selectedDays = [];

        if (mode === 'single') {
            selectedDays = [targetVal.toString()];
        } else if (mode === 'range') {
            for (let i = 1; i <= targetVal; i++) selectedDays.push(i.toString());
        } else {
            const checkboxes = document.querySelectorAll('.day-cb:checked');
            checkboxes.forEach(cb => selectedDays.push(cb.value));
        }

        if (selectedDays.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡æˆ–è¼¸å…¥ä¸€å€‹å¤©æ•¸ï¼");
            return;
        }

        currentWords = allVocab.filter(v => {
            const dayValue = (v.day || v.DAY || "").toString().trim();
            return selectedDays.includes(dayValue);
        });

        currentWords.sort(() => 0.5 - Math.random());
        render();
    }

    function playAudio(word) {
        if (!word || word === '-') return;
        const audio = new Audio(`audio/${word.trim().toLowerCase()}.mp3`);
        audio.play().catch(e => console.log("Audio not found: " + word));
    }

    function render() {
        const display = document.getElementById('mainDisplay');
        display.innerHTML = '';
        userAnswers = {};

        if (currentWords.length === 0) {
            display.innerHTML = `<p style="text-align:center; color:#ff7675;">âš ï¸ æ‰¾ä¸åˆ°å°æ‡‰æ—¥å­çš„ç”Ÿå­—ï¼Œè«‹ç¢ºèª CSV è¨­å®šã€‚</p>`;
            return;
        }

        currentWords.forEach((item, i) => {
            const typeClass = item.type.toLowerCase() === 'core' ? 'badge-core' : 'badge-elite';
            const word = item.word.toUpperCase();
            const letters = word.split('').sort(() => 0.5 - Math.random());

            const card = document.createElement('div');
            card.innerHTML = `
                <div class="vocab-card web-interactive-area">
                    <div id="learn-view-${i}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="badge ${typeClass}">${item.type} (Day ${item.day})</span>
                            <div>
                                <button class="btn btn-audio" onclick="playAudio('${item.word}')">ğŸ”Š Word</button>
                                <button class="btn btn-record" id="rec-${i}" onclick="toggleRecord(${i})">ğŸ¤</button>
                                <button class="btn btn-play-rec" id="play-${i}" style="display:none;">â–¶ï¸</button>
                            </div>
                        </div>
                        
                        <h2 style="color:var(--core); margin: 15px 0; font-size: 2em;">${i+1}. ${item.word}</h2>
                        <p><strong style="color: #f1c40f;">ğŸ’¡ Mnemonic:</strong><br>${item.memory || ''}</p>

                        <div style="display: flex; background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 15px; margin-top: 15px; border: 1px solid #334155;">
                            <div style="flex: 1; border-right: 1px solid #4b5563; padding-right: 15px;">
                                <div style="color: var(--core); font-weight: bold; font-size: 0.8em;">ğŸŸ¢ SYNONYM</div>
                                <div style="font-size: 1.1em; display:flex; align-items:center; gap:5px;">
                                    ${item.syn || '-'} 
                                    ${item.syn ? `<button class="btn-audio" style="border-radius:50%;" onclick="playAudio('${item.syn}')">ğŸ”Š</button>` : ''}
                                </div>
                            </div>
                            <div style="flex: 1; padding-left: 15px;">
                                <div style="color: var(--elite); font-weight: bold; font-size: 0.8em;">ğŸ”´ ANTONYM</div>
                                <div style="font-size: 1.1em; display:flex; align-items:center; gap:5px;">
                                    ${item.ant || '-'}
                                    ${item.ant ? `<button class="btn-audio" style="border-radius:50%;" onclick="playAudio('${item.ant}')">ğŸ”Š</button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="challenge-view-${i}" style="display: none;">
                        <div class="spell-area">
                            <div class="answer-display" id="ans-${i}"></div>
                            <div class="letter-pool" id="pool-${i}">
                                ${letters.map(l => `<button class="letter-btn" onclick="addLetter(${i}, '${l}', this)">${l}</button>`).join('')}
                            </div>
                            <div class="control-btns" style="margin-top:20px; text-align:center;">
                                <button class="btn" style="background:#e67e22; color:white;" onclick="backspace(${i})">â¬…ï¸ Back</button>
                                <button class="btn" style="background:#27ae60; color:white;" id="submit-btn-${i}" onclick="submitAnswer(${i})">ğŸš€ Submit</button>
                            </div>
                        </div>
                    </div>

                    <button class="btn" id="btn-toggle-${i}" onclick="toggleChallenge(${i})" style="width: 100%; margin-top: 20px; background: var(--primary); color: white;">
                        ğŸ¯ Start Challenge (Lock)
                    </button>
                </div>
            `;
            display.appendChild(card);
        });
    }

    // æ‹¼å­—é‚è¼¯èˆ‡éŒ„éŸ³é‚è¼¯ä¿æŒèˆ‡åŸç‰ˆä¸€è‡´ (å› ç¯‡å¹…çœç•¥é‡è¤‡éƒ¨åˆ†ï¼Œä½†åŠŸèƒ½ä¸è®Š)
    function toggleChallenge(i) {
        document.getElementById(`learn-view-${i}`).style.display = 'none';
        document.getElementById(`challenge-view-${i}`).style.display = 'block';
        document.getElementById(`btn-toggle-${i}`).style.display = 'none';
    }

    function addLetter(wordIdx, letter, btn) {
        if(!userAnswers[wordIdx]) userAnswers[wordIdx] = "";
        userAnswers[wordIdx] += letter;
        btn.disabled = true;
        document.getElementById(`ans-${wordIdx}`).innerText = userAnswers[wordIdx];
    }

    function backspace(wordIdx) {
        if(!userAnswers[wordIdx] || userAnswers[wordIdx].length === 0) return;
        const lastLetter = userAnswers[wordIdx].slice(-1);
        userAnswers[wordIdx] = userAnswers[wordIdx].slice(0, -1);
        const pool = document.getElementById(`pool-${wordIdx}`);
        const btns = pool.getElementsByTagName('button');
        for (let btn of btns) {
            if (btn.innerText === lastLetter && btn.disabled) {
                btn.disabled = false;
                break;
            }
        }
        document.getElementById(`ans-${wordIdx}`).innerText = userAnswers[wordIdx];
    }

    async function submitAnswer(wordIdx) {
        const correctWord = currentWords[wordIdx].word.toUpperCase();
        const userAnswer = userAnswers[wordIdx] || "";
        const btn = document.getElementById(`submit-btn-${wordIdx}`);
        if (userAnswer.length < correctWord.length) return;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const payload = {
            student: STUDENT_NAME, 
            week: currentWords[wordIdx].day,
            correctWord: correctWord,
            userAnswer: userAnswer,
            status: (correctWord === userAnswer) ? "âœ… Correct" : "âŒ Incorrect"
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            btn.innerText = "âœ… Submitted";
            document.getElementById(`ans-${wordIdx}`).style.color = (payload.status === "âœ… Correct") ? "#55efc4" : "#ff7675";
        } catch (e) { btn.innerText = "âŒ Error"; btn.disabled = false; }
    }

    async function toggleRecord(id) {
        const btn = document.getElementById(`rec-${id}`);
        const playBtn = document.getElementById(`play-${id}`);
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
                mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
                audioChunks[id] = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks[id].push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks[id], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    playBtn.style.display = 'inline-block';
                    playBtn.onclick = () => { const audio = new Audio(url); audio.play(); };
                };
                mediaRecorder.start();
                btn.innerText = "ğŸ›‘ Stop";
                btn.style.background = "#ff7675";
            } catch (err) { alert("éº¥å…‹é¢¨é–‹å•Ÿå¤±æ•—"); }
        } else {
            mediaRecorder.stop();
            btn.innerText = "ğŸ¤";
            btn.style.background = "#e74c3c";
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
    }
</script>

</body>
</html>
