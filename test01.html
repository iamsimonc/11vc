<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kathryn 11+ VR Expert Mode</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<style>
:root {
  --primary:#6c5ce7; --core:#55efc4; --elite:#fd79a8;
  --bg:#0f172a; --card-bg:#1e293b; --text:#f8fafc;
}
body { background:var(--bg); color:var(--text); font-family:Arial; padding:20px; }
.container { max-width:900px; margin:auto; }
.vocab-card {
  background:var(--card-bg); padding:25px; border-radius:15px;
  margin-bottom:25px; border-left:10px solid var(--primary);
}
.btn { padding:10px 18px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }
.btn-gen{background:var(--primary);color:#fff;}
.btn-audio{background:#4b5563;color:#fff;}
.btn-record{background:#e74c3c;color:#fff;}
.btn-play-rec{background:#f1c40f;color:#000;}
.badge-core{background:var(--core);color:#000;}
.badge-elite{background:var(--elite);color:#fff;}
</style>
</head>

<body>
<div class="container">

<h1>ğŸš€ Kathryn 11+ VR ç·´ç¿’ç³»çµ±</h1>
<label>Weekï¼š</label>
<input id="weekInput" type="number" value="1" style="width:60px">
<button class="btn btn-gen" onclick="generateByWeek()">Generate</button>

<div id="mainDisplay"></div>
</div>

<script>
let allVocab = [];
let currentWords = [];
let mediaRecorder;
let audioChunks = {};

/* ---------- CSV ---------- */
Papa.parse("vocab.csv", {
  download:true,
  header:true,
  skipEmptyLines:true,
  complete:(r)=>{
    allVocab = r.data.filter(v=>v.word && v.week);
    generateByWeek();
  }
});

/* ---------- æ ¸å¿ƒï¼šæ¯é€±ä¸é‡è¤‡æŠ½ 5 å€‹ ---------- */
function generateByWeek(){
  const week = document.getElementById('weekInput').value;
  const pool = allVocab.filter(v=>String(v.week)===String(week));

  const key = `USED_WEEK_${week}`;
  let used = JSON.parse(localStorage.getItem(key) || "[]");

  let available = pool.filter(v=>!used.includes(v.word));

  if(available.length < 5){
    used = [];
    available = [...pool];
  }

  shuffle(available);
  currentWords = available.slice(0,5);
  currentWords.forEach(w=>used.push(w.word));

  localStorage.setItem(key, JSON.stringify(used));
  render();
}

/* ---------- UI ---------- */
function render(){
  const display = document.getElementById('mainDisplay');
  display.innerHTML = "";

  currentWords.forEach((item,i)=>{
    const typeClass = item.type.toUpperCase()==="CORE" ? "badge-core":"badge-elite";
    const word = item.word.toUpperCase();

    const div = document.createElement("div");
    div.className="vocab-card";
    div.innerHTML = `
      <span class="badge ${typeClass}">${item.type}</span>
      <h2>${i+1}. ${item.word}</h2>

      <button class="btn btn-audio" onclick="playNative('${item.word}')">ğŸ”Š Voice</button>
      <button class="btn btn-record" id="rec-${i}" onclick="toggleRecord(${i})">ğŸ¤</button>
      <button class="btn btn-play-rec" id="play-${i}" style="display:none;">â–¶ï¸</button>

      <p><b>Mnemonicï¼š</b>${item.memory}</p>
      <p>ğŸŸ¢ ${item.syn} ï½œ ğŸ”´ ${item.ant}</p>

      <hr>

      <h3>ğŸ§© Spelling Challenge</h3>
      <div id="spell-answer-${i}" style="font-size:2em;letter-spacing:10px;"></div>
      <div id="spell-letters-${i}" style="margin:10px 0;"></div>

      <button class="btn btn-record" onclick="spellBack(${i})">âŒ«</button>
      <button class="btn btn-play-rec" onclick="submitSpell(${i},'${word}')">Submit</button>
    `;
    display.appendChild(div);
    initSpell(i, word);
  });
}

/* ---------- æ‹¼å­— ---------- */
let spellState = {};

function initSpell(i, word){
  const letters = shuffle(word.split(""));
  spellState[i] = { word, answer:Array(word.length).fill("") };

  document.getElementById(`spell-answer-${i}`).innerText =
    spellState[i].answer.join(" ");

  const box = document.getElementById(`spell-letters-${i}`);
  box.innerHTML="";
  letters.forEach(l=>{
    const b=document.createElement("button");
    b.className="btn btn-gen";
    b.innerText=l;
    b.onclick=()=>{
      const idx=spellState[i].answer.indexOf("");
      if(idx>-1){
        spellState[i].answer[idx]=l;
        document.getElementById(`spell-answer-${i}`).innerText =
          spellState[i].answer.join(" ");
      }
    };
    box.appendChild(b);
  });
}

function spellBack(i){
  const arr = spellState[i].answer;
  for(let x=arr.length-1;x>=0;x--){
    if(arr[x]!==""){arr[x]="";break;}
  }
  document.getElementById(`spell-answer-${i}`).innerText = arr.join(" ");
}

function submitSpell(i, word){
  alert("Saved: "+spellState[i].answer.join(""));
}

/* ---------- å·¥å…· ---------- */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function playNative(word){
  new Audio(`audio/${word.toLowerCase()}.mp3`).play();
}

/* ---------- éŒ„éŸ³ ---------- */
async function toggleRecord(id){
  const btn=document.getElementById(`rec-${id}`);
  if(!mediaRecorder||mediaRecorder.state==="inactive"){
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    audioChunks[id]=[];
    mediaRecorder.ondataavailable=e=>audioChunks[id].push(e.data);
    mediaRecorder.onstop=()=>{
      const url=URL.createObjectURL(new Blob(audioChunks[id]));
      const p=document.getElementById(`play-${id}`);
      p.style.display="inline-block";
      p.onclick=()=>new Audio(url).play();
    };
    mediaRecorder.start();
    btn.innerText="Stop";
  }else{
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    btn.innerText="ğŸ¤";
  }
}
</script>
</body>
</html>
