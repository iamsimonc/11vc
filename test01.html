<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathryn 11+ VR Expert Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --core: #55efc4; --elite: #fd79a8; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        .no-print { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #334155; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-right: 5px; transition: 0.3s; }
        .btn-audio { background: #4b5563; color: white; }
        .btn-record { background: #e74c3c; color: white; }
        .btn-play-rec { background: #f1c40f; color: black; }
        .btn-gen { background: var(--primary); color: white; }
        
        /* æ‹¼å­—éŠæˆ²æ¨£å¼ */
        .spell-area { background: #0f172a; padding: 20px; border-radius: 12px; border: 2px solid #334155; margin-top: 15px; }
        .answer-display { font-size: 2em; min-height: 1.2em; border-bottom: 3px solid var(--primary); margin-bottom: 20px; letter-spacing: 5px; color: #fff; font-family: monospace; }
        .letter-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .letter-btn { background: #334155; color: white; border: 2px solid #4b5563; padding: 10px 15px; font-size: 1.5em; border-radius: 8px; cursor: pointer; min-width: 45px; }
        .letter-btn:disabled { opacity: 0.3; cursor: default; }
        .letter-btn:active { background: var(--primary); }
        .control-btns { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .btn-back { background: #e67e22; color: white; }
        .btn-submit { background: #27ae60; color: white; }

        .vocab-card { background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 10px solid var(--primary); }
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
        .badge-core { background: var(--core); color: #000; }
        .badge-elite { background: var(--elite); color: #fff; }

        .test-item { display: none; padding: 20px; border: 1px solid #000; margin-bottom: 25px; page-break-inside: avoid; }
        
        @media print {
            body { background: white !important; color: black !important; }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
            .no-print, .btn, .web-interactive-area { display: none !important; }
            .test-item { display: block !important; visibility: visible !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1>ğŸš€ Kathryn 11+ VR äº’å‹•ç·´ç¿’ç³»çµ±</h1>
        <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            <label>è¼¸å…¥ Week: </label>
            <input type="number" id="weekInput" value="1" style="width:50px; padding:8px;">
            <button class="btn btn-gen" onclick="generateByWeek()">ğŸ”„ ç”Ÿæˆæœ¬é€± 5 å€‹å­— (3:2)</button>
            <button class="btn" style="background:#27ae60; color:white;" onclick="printTest('standard')">ğŸ–¨ï¸ æ¨™æº–å¡«ç©º</button>
            <button class="btn" style="background:#2980b9; color:white;" onclick="printTest('anagram')">ğŸ–¨ï¸ å­—æ¯é‡çµ„</button>
        </div>
        <p style="font-size: 0.9em; color: #aaa;">* é»æ“Š "Start Challenge" é–‹å•Ÿ iPad é»æ“Šæ‹¼å­—æ¨¡å¼ï¼Œçµæœæœƒè‡ªå‹•å­˜æª”ã€‚</p>
    </div>

    <div id="mainDisplay"></div>
</div>

<script>
    let allVocab = [];
    let currentWords = [];
    let mediaRecorder;
    let audioChunks = {};
    let currentTestType = 'standard';
    let userAnswers = {}; // ç´€éŒ„æ¯é¡Œé»æ“Šçš„ç­”æ¡ˆ

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxPeeeBTqiT2-MFsH4R_aHTPOdGZTeNicNJWMA4qG1jGasJHjpi_as_cUGoeS_Y3Ck8sg/exec";

    window.onload = function() {
        Papa.parse("vocab.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                allVocab = results.data.filter(row => row.word);
                generateByWeek();
            }
        });
    };

    function generateByWeek() {
        const week = parseInt(document.getElementById('weekInput').value) || 1;
        const cores = allVocab.filter(v => v.type.toUpperCase() === 'CORE');
        const elites = allVocab.filter(v => v.type.toUpperCase() === 'ELITE');

        const seedShuffle = (arr, seed) => {
            let m = arr.length, t, i;
            while (m) {
                i = Math.floor(Math.abs(Math.sin(seed++)) * m--);
                t = arr[m]; arr[m] = arr[i]; arr[i] = t;
            }
            return arr;
        };

        // è¦å‰‡ 1: æ”¹ç‚ºæ¯é€± 5 å€‹å­— (3 Core + 2 Elite)
        const startC = (week - 1) * 3;
        const startE = (week - 1) * 2;
        
        let poolC = seedShuffle([...cores], week).slice(startC, startC + 3);
        let poolE = seedShuffle([...elites], week + 50).slice(startE, startE + 2);

        currentWords = seedShuffle([...poolC, ...poolE], week + 99);
        render();
    }

    function playNative(word) {
        const audio = new Audio(`audio/${word.toLowerCase()}.mp3`);
        audio.play().catch(e => console.log("Audio not found"));
    }

    // æ‹¼å­—äº’å‹•é‚è¼¯
    function addLetter(wordIdx, letter, btn) {
        if(!userAnswers[wordIdx]) userAnswers[wordIdx] = "";
        userAnswers[wordIdx] += letter;
        btn.disabled = true;
        updateSpellDisplay(wordIdx);
    }

    function backspace(wordIdx) {
        if(!userAnswers[wordIdx] || userAnswers[wordIdx].length === 0) return;
        const lastLetter = userAnswers[wordIdx].slice(-1);
        userAnswers[wordIdx] = userAnswers[wordIdx].slice(0, -1);
        
        // æ¢å¾©æŒ‰éˆ•å¯ç”¨ç‹€æ…‹
        const pool = document.getElementById(`pool-${wordIdx}`);
        const btns = pool.getElementsByTagName('button');
        for (let btn of btns) {
            if (btn.innerText === lastLetter && btn.disabled) {
                btn.disabled = false;
                break;
            }
        }
        updateSpellDisplay(wordIdx);
    }

    function updateSpellDisplay(wordIdx) {
        document.getElementById(`ans-${wordIdx}`).innerText = userAnswers[wordIdx];
    }

    async function submitAnswer(wordIdx) {
        const week = document.getElementById('weekInput').value;
        const correctWord = currentWords[wordIdx].word.toUpperCase();
        const userAnswer = userAnswers[wordIdx] || "";
        const btn = document.getElementById(`submit-btn-${wordIdx}`);

        if (userAnswer.length < correctWord.length) {
            alert("Please complete the word first!");
            return;
        }

        btn.innerText = "Saving...";
        btn.disabled = true;

        // å‚³é€åˆ° Google Sheets
        try {
            const formData = new URLSearchParams();
            formData.append('week', week);
            formData.append('correctWord', correctWord);
            formData.append('userAnswer', userAnswer);
            formData.append('status', correctWord === userAnswer ? "âœ… Correct" : "âŒ Incorrect");

            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });

            alert(correctWord === userAnswer ? "Great job! Correct! ğŸ‰" : `Keep trying! The correct answer is ${correctWord}`);
            btn.innerText = "âœ… Submitted";
        } catch (e) {
            alert("Submission failed, but don't worry, keep practicing!");
            btn.disabled = false;
            btn.innerText = "Submit";
        }
    }

    function render() {
        const display = document.getElementById('mainDisplay');
        display.innerHTML = '';
        userAnswers = {};

        currentWords.forEach((item, i) => {
            const typeClass = item.type.toLowerCase() === 'core' ? 'badge-core' : 'badge-elite';
            const word = item.word.toUpperCase();
            const letters = word.split('').sort(() => 0.5 - Math.random());
            const sentence = `The boy sa${word.slice(0,2).toLowerCase()} i${word.slice(2).toLowerCase()} it was great.`.replace("  ", " ");

            const card = document.createElement('div');
            card.innerHTML = `
                <div class="vocab-card word-info web-interactive-area">
                    <div id="learn-view-${i}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="badge ${typeClass}">${item.type}</span>
                            <div>
                                <button class="btn btn-audio" onclick="playNative('${item.word}')">ğŸ”Š Voice</button>
                                <button class="btn btn-record" id="rec-${i}" onclick="toggleRecord(${i})">ğŸ¤</button>
                                <button class="btn btn-play-rec" id="play-${i}" style="display:none;">â–¶ï¸</button>
                            </div>
                        </div>
                        <h2 style="color:var(--core); margin: 10px 0;">${i+1}. ${item.word}</h2>
                        <p><strong style="color: #f1c40f;">ğŸ’¡ Mnemonic:</strong> ${item.memory}</p>
                    </div>

                    <div id="challenge-view-${i}" style="display: none;">
                        <div class="spell-area">
                            <div class="answer-display" id="ans-${i}"></div>
                            <div class="letter-pool" id="pool-${i}">
                                ${letters.map(l => `<button class="letter-btn" onclick="addLetter(${i}, '${l}', this)">${l}</button>`).join('')}
                            </div>
                            <div class="control-btns">
                                <button class="btn btn-back" onclick="backspace(${i})">â¬…ï¸ Back Space</button>
                                <button class="btn btn-submit" id="submit-btn-${i}" onclick="submitAnswer(${i})">ğŸš€ Submit</button>
                            </div>
                        </div>
                    </div>

                    <button class="btn" id="btn-toggle-${i}" onclick="toggleChallenge(${i})" style="width: 100%; margin-top: 20px; background: var(--primary);">
                        ğŸ¯ Start Challenge (Hide Word)
                    </button>
                </div>

                <div class="test-item">
                    <span>11+ VR Test: Week ${document.getElementById('weekInput').value}</span>
                    <p><b>Q${i+1}:</b> Anagram: ${letters.join(' ')} (Synonym: ${item.syn})</p>
                    <p>Answer: ___________________________</p>
                </div>
            `;
            display.appendChild(card);
        });
    }

    function toggleChallenge(i) {
        const lv = document.getElementById(`learn-view-${i}`);
        const cv = document.getElementById(`challenge-view-${i}`);
        const btn = document.getElementById(`btn-toggle-${i}`);
        if (lv.style.display !== 'none') {
            lv.style.display = 'none'; cv.style.display = 'block';
            btn.innerText = 'ğŸ‘ï¸ Show Word (Peek)';
        } else {
            lv.style.display = 'block'; cv.style.display = 'none';
            btn.innerText = 'ğŸ¯ Start Challenge (Hide Word)';
        }
    }

    // éŒ„éŸ³åŠŸèƒ½ä¿æŒä¸è®Š (çœç•¥éƒ¨åˆ†é‡è¤‡ä»£ç¢¼ä»¥ä¿æŒç°¡æ½”)
    async function toggleRecord(id) { /* åŸæœ‰éŒ„éŸ³é‚è¼¯ */ }
</script>

</body>
</html>
