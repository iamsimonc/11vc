<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kathryn 11+ VR Expert Mode</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
:root { --primary: #6c5ce7; --core: #55efc4; --elite: #fd79a8; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
.container { max-width: 900px; margin: auto; }
.no-print { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #334155; }
.btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-right: 5px; transition: 0.3s; }
.btn-audio { background: #4b5563; color: white; }
.btn-record { background: #e74c3c; color: white; }
.btn-play-rec { background: #f1c40f; color: black; }
.btn-gen { background: var(--primary); color: white; }
.vocab-card { background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 10px solid var(--primary); }
.badge { padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
.badge-core { background: var(--core); color: #000; }
.badge-elite { background: var(--elite); color: #fff; }
.test-item { display: none; padding: 20px; border: 1px solid #000; margin-bottom: 25px; page-break-inside: avoid; }
@media print {
    body { background: white !important; color: black !important; }
    .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
    .no-print, .btn, .web-interactive-area { display: none !important; }
    .test-item { display: block !important; visibility: visible !important; }
}
</style>
</head>
<body>

<div class="container">
<div class="no-print">
<h1>ğŸš€ Kathryn 11+ VR ç·´ç¿’ç³»çµ±</h1>
<div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
<label>è¼¸å…¥ Week: </label>
<input type="number" id="weekInput" value="1" style="width:50px; padding:8px;">
<button class="btn btn-gen" onclick="generateByWeek()">ğŸ”„ éš¨æ©Ÿç”Ÿæˆæœ¬é€± (5å€‹)</button>
<button class="btn" style="background:#27ae60; color:white;" onclick="startTest()">ğŸ“ ç·šä¸Šæ¸¬é©—</button>
</div>
<p style="font-size: 0.9em; color: #aaa;">* ç·šä¸Šæ¸¬é©—æœƒè‡ªå‹•è¨ˆåˆ†ä¸¦ä¸Šå‚³æˆç¸¾åˆ° Google Sheet</p>
<p>æŸ¥çœ‹æˆç¸¾èˆ‡åˆ†æï¼š<a href="https://docs.google.com/spreadsheets/d/AKfycbyVKRndDLY1M46DBzCQV79UWU6EsQBiP33VWK6HAqNWMnWfT-D5Ck3SjOrQ0vyS9NF29Q/edit" target="_blank">ğŸ“Š Kathryn çš„æˆç¸¾ Dashboard</a></p>
</div>

<div id="mainDisplay"></div>
<div id="testArea" style="margin-top: 30px;"></div>
</div>

<script>
let allVocab = [];
let currentWords = [];
let mediaRecorder;
let audioChunks = {};
let currentTestType = 'standard';

// 1. åŠ è¼‰ CSV
window.onload = function() {
    if(window.speechSynthesis){ window.speechSynthesis.getVoices(); }
    Papa.parse("vocab.csv", {
        download: true, header: true, skipEmptyLines: true,
        complete: function(results){
            allVocab = results.data.filter(r=>r.word);
            generateByWeek();
        }
    });
};

// 2. ç”Ÿæˆæ¯é€± 5 å€‹å­— (70% æ˜“å­—, 30% é›£å­—)
function generateByWeek() {
    const week = parseInt(document.getElementById('weekInput').value)||1;
    const cores = allVocab.filter(v=>v.type.toUpperCase()==='CORE');
    const elites = allVocab.filter(v=>v.type.toUpperCase()==='ELITE');

    const seedShuffle = (arr, seed)=>{
        let m=arr.length,t,i;
        while(m){
            i = Math.floor(Math.abs(Math.sin(seed++))*m--);
            t = arr[m]; arr[m]=arr[i]; arr[i]=t;
        }
        return arr;
    };

    let poolC = seedShuffle([...cores], week).slice(0, Math.ceil(5*0.7));
    let poolE = seedShuffle([...elites], week+50).slice(0, Math.floor(5*0.3));
    currentWords = seedShuffle([...poolC,...poolE], week+99);
    render();
}

// 3. æ¸²æŸ“ç•«é¢ï¼ˆä¿ç•™åŸæœ¬éŒ„éŸ³/æ’­æ”¾ï¼‰
function render(){
    const display = document.getElementById('mainDisplay');
    display.innerHTML='';
    currentWords.forEach((item,i)=>{
        const typeClass = item.type.toLowerCase()==='core'?'badge-core':'badge-elite';
        const word = item.word.toUpperCase();
        const displayWord = item.word;

        const card = document.createElement('div');
        card.innerHTML=`
        <div class="vocab-card word-info web-interactive-area">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="badge ${typeClass}">${item.type}</span>
                <div>
                    <button class="btn btn-audio" onclick="playAudio('${displayWord}')">ğŸ”Š Voice</button>
                    <button class="btn btn-record" id="rec-${i}" onclick="toggleRecord(${i})">ğŸ¤</button>
                    <button class="btn btn-play-rec" id="play-${i}" style="display:none;">â–¶ï¸</button>
                </div>
            </div>
            <h2 style="color:var(--core); margin: 10px 0;">${i+1}. ${displayWord}</h2>
            <p><strong style="color:#f1c40f;">ğŸ’¡ Mnemonic:</strong><br><span>${item.memory}</span></p>
            <div style="display:flex;gap:30px;background:rgba(0,0,0,0.2);padding:10px;border-radius:8px;">
                <div><span style="color:#55efc4;font-weight:bold;">ğŸŸ¢ SYNONYM</span><br><span>${item.syn}</span></div>
                <div style="border-left:1px solid #444;padding-left:30px;"><span style="color:#ff7675;font-weight:bold;">ğŸ”´ ANTONYM</span><br><span>${item.ant}</span></div>
            </div>
        </div>
        `;
        display.appendChild(card);
    });
}

// 4. æ’­éŸ³æ”¹ç”¨ MP3
function playAudio(word){
    const audio = new Audio(`audio/${word}.mp3`);
    audio.play();
}

// 5. éŒ„éŸ³åŠŸèƒ½
async function toggleRecord(id){
    const btn = document.getElementById(`rec-${id}`);
    if(!mediaRecorder||mediaRecorder.state==="inactive"){
        try{
            const mimeType=MediaRecorder.isTypeSupported("audio/mp4")?"audio/mp4":"audio/webm";
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(stream,{mimeType});
            audioChunks[id]=[];
            mediaRecorder.ondataavailable=e=>{if(e.data.size>0) audioChunks[id].push(e.data);}
            mediaRecorder.onstop=()=>{
                const blob = new Blob(audioChunks[id],{type:mimeType});
                const url = URL.createObjectURL(blob);
                const playBtn = document.getElementById(`play-${id}`);
                playBtn.style.display='inline-block';
                playBtn.onclick=()=>{const a=new Audio(url); a.play();}
            }
            mediaRecorder.start();
            btn.innerText="ğŸ›‘ Stop"; btn.style.background="#000";
        }catch(e){alert("ç„¡æ³•ä½¿ç”¨éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™èˆ‡HTTPS");}
    }else{
        mediaRecorder.stop();
        if(mediaRecorder.stream) mediaRecorder.stream.getTracks().forEach(t=>t.stop());
        btn.innerText="ğŸ¤ Re-record"; btn.style.background="#e74c3c";
    }
}

// 6. ç·šä¸Šæ¸¬é©—åŠŸèƒ½
function startTest(){
    const testArea=document.getElementById('testArea');
    testArea.innerHTML='';
    const answers=[];
    currentWords.forEach((item,i)=>{
        const div=document.createElement('div');
        div.innerHTML=`
        <p>${i+1}. ${item.word.toUpperCase()} - è«‹å¡«å¯«æ‹¼å¯«: <input type="text" id="ans-${i}" style="padding:5px;"></p>
        `;
        testArea.appendChild(div);
        answers.push({word:item.word, inputId:`ans-${i}`});
    });

    const submitBtn=document.createElement('button');
    submitBtn.className='btn btn-gen';
    submitBtn.innerText='âœ… æäº¤æ¸¬é©—';
    submitBtn.onclick=()=>{submitTest(answers)};
    testArea.appendChild(submitBtn);
}

// 7. æäº¤æ¸¬é©—ã€è¨ˆåˆ†ã€ä¸Šå‚³ Google Sheet
function submitTest(answers){
    let correct=0;
    const wrongWords=[];
    answers.forEach(a=>{
        const val=document.getElementById(a.inputId).value.trim().toLowerCase();
        if(val===a.word.toLowerCase()) correct++; else wrongWords.push(a.word);
    });
    const total=answers.length;
    alert(`ä½ å¾—åˆ† ${correct}/${total} (${Math.round(correct/total*100)}%)`);

    // ä¸Šå‚³ Google Sheet
    fetch('https://script.google.com/macros/s/AKfycbyVKRndDLY1M46DBzCQV79UWU6EsQBiP33VWK6HAqNWMnWfT-D5Ck3SjOrQ0vyS9NF29Q/exec',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            student:'Kathryn',
            week:parseInt(document.getElementById('weekInput').value)||1,
            total:total,
            correct:correct,
            wrongWords:wrongWords
        })
    }).then(res=>res.json()).then(d=>console.log('å·²ä¸Šå‚³',d)).catch(err=>console.error(err));
}
</script>

</body>
</html>
