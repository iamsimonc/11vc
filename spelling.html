<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11+ VR Vocabulary Practice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --core: #55efc4; --elite: #fd79a8; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; --wrong: #ff7675; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        .no-print { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #334155; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-right: 5px; transition: 0.3s; }
        .btn-audio { background: #4b5563; color: white; padding: 5px 10px; font-size: 0.8em; }
        .btn-record { background: #e74c3c; color: white; }
        .btn-play-rec { background: #f1c40f; color: black; }
        .btn-gen { background: var(--primary); color: white; }
        
        .selection-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-top: 10px; }
        #checkbox-container { display: none; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 5px; margin-top: 10px; max-height: 150px; overflow-y: auto; padding: 10px; background: #0f172a; border-radius: 8px; }
        .day-check { display: flex; align-items: center; gap: 3px; font-size: 0.9em; }

        .spell-area { background: #0f172a; padding: 20px; border-radius: 12px; border: 2px solid #334155; margin-top: 15px; position: relative;}
        .answer-display { font-size: 2em; min-height: 1.2em; border-bottom: 3px solid var(--primary); margin-bottom: 20px; letter-spacing: 5px; color: #fff; font-family: monospace; text-align: center; }
        .letter-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .letter-btn { background: #334155; color: white; border: 2px solid #4b5563; padding: 10px 15px; font-size: 1.5em; border-radius: 8px; cursor: pointer; min-width: 45px; }
        .letter-btn:disabled { opacity: 0.3; cursor: default; }
        
        .vocab-card { background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 10px solid var(--primary); }
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
        .badge-core { background: var(--core); color: #000; }
        .badge-elite { background: var(--elite); color: #fff; }

        .def-text { font-size: 0.9em; color: #cbd5e1; font-style: italic; margin-top: 4px; line-height: 1.4; }
        .sub-def { font-size: 0.75em; color: #94a3b8; margin-top: 5px; line-height: 1.3; }

        .result-box { margin-top: 15px; padding: 15px; border-radius: 10px; font-weight: bold; display: none; text-align: center; }
        .result-correct { background: rgba(85, 239, 196, 0.1); border: 1px solid var(--core); color: var(--core); }
        .result-wrong { background: rgba(255, 118, 117, 0.1); border: 1px solid var(--wrong); color: var(--wrong); }
        .correct-ans-label { color: var(--core); text-decoration: none; margin-left: 10px; font-size: 1.2em; font-weight: 800;}
        .user-ans-label { text-decoration: line-through; opacity: 0.7; }

        input[type="text"] { padding: 8px; border-radius: 5px; border: 1px solid #334155; background: #0f172a; color: white; }

        @media print {
            .no-print, .btn, .web-interactive-area, .btn-audio, #final-submit-area { display: none !important; }
            .vocab-card { border: 1px solid #000; color: black !important; background: white !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1>üöÄ 11+ Vocabulary Practice</h1>
        
        <div class="selection-box">
            <div style="margin-bottom: 15px;">
                <label>üë§ Student Name: </label>
                <input type="text" id="studentName" placeholder="Enter name here..." style="width: 200px;">
            </div>

            <div style="margin-bottom: 10px;">
                <label>Select modeÔºö</label>
                <select id="modeSelect" onchange="toggleModeUI()" style="padding:5px; border-radius:5px;">
                    <option value="single">Single Day (Day X)</option>
                    <option value="range">Continuous mode (Day 1 to Day X)</option>
                    <option value="multi">Multimode (select day)</option>
                </select>
            </div>

            <div id="ui-single-range">
                <label id="inputLabel">input day: </label>
                <input type="number" id="weekInput" value="1" style="width:60px; padding:8px; border-radius:5px; border:1px solid #ccc;">
            </div>

            <div id="ui-multi" style="display:none;">
                <button class="btn" style="background:#4b5563; font-size:0.8em;" onclick="toggleCheckboxArea()">üìÇ Â±ïÈñã/Êî∂Ëµ∑Êó•Â≠êÈÅ∏Êìá</button>
                <div id="checkbox-container"></div>
            </div>

            <div style="margin-top: 15px;">
                <button class="btn btn-gen" onclick="generateVocab()">üîÑ Start Practice</button>
                <button class="btn" style="background:#27ae60; color:white;" onclick="window.print()">üñ®Ô∏è Print Paper</button>
            </div>
        </div>
    </div>

    <div id="mainDisplay"></div>
    
    <div id="final-submit-area" style="display:none; text-align:center; padding: 40px 0;">
        <hr style="border: 0; border-top: 1px solid #334155; margin-bottom: 20px;">
        <button class="btn btn-gen" id="mainSubmitBtn" onclick="submitAllAnswers()" style="font-size: 1.5em; padding: 15px 40px;">üé¨ Finish & Submit All</button>
        <p id="overall-feedback" style="margin-top: 15px; font-size: 1.2em; font-weight: bold;"></p>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxEvoOp6elsVsYby0oY6cU5GrghiTd7tsh_o07q-wgHxhr51xHCnsyCvYIYeN-YOCYpjw/exec"; 
    let allVocab = [];
    let currentWords = [];
    let mediaRecorder;
    let audioChunks = {};
    let userAnswers = {};

    window.onload = function() {
        const container = document.getElementById('checkbox-container');
        for (let i = 1; i <= 150; i++) {
            container.innerHTML += `<div class="day-check"><input type="checkbox" class="day-cb" value="${i}"> ${i}</div>`;
        }

        Papa.parse("vocab.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                allVocab = results.data;
            }
        });
    };

    function toggleModeUI() {
        const mode = document.getElementById('modeSelect').value;
        document.getElementById('ui-single-range').style.display = (mode === 'multi') ? 'none' : 'block';
        document.getElementById('ui-multi').style.display = (mode === 'multi') ? 'block' : 'none';
        document.getElementById('inputLabel').innerText = (mode === 'range') ? "Day 1 to: " : "input day: ";
    }

    function toggleCheckboxArea() {
        const container = document.getElementById('checkbox-container');
        container.style.display = (container.style.display === 'grid') ? 'none' : 'grid';
    }

    function generateVocab() {
        const name = document.getElementById('studentName').value.trim();
        if(!name) { alert("Please enter student name first!"); return; }

        const mode = document.getElementById('modeSelect').value;
        const targetVal = parseInt(document.getElementById('weekInput').value);
        let selectedDays = [];

        if (mode === 'single') {
            selectedDays = [targetVal.toString()];
        } else if (mode === 'range') {
            for (let i = 1; i <= targetVal; i++) selectedDays.push(i.toString());
        } else {
            document.querySelectorAll('.day-cb:checked').forEach(cb => selectedDays.push(cb.value));
        }

        if (selectedDays.length === 0) {
            alert("Ë´ãËá≥Â∞ëÈÅ∏ÊìáÊàñËº∏ÂÖ•‰∏ÄÂÄãÂ§©Êï∏ÔºÅ");
            return;
        }

        currentWords = allVocab.filter(v => {
            const dayValue = (v.day || v.DAY || "").toString().trim();
            return selectedDays.includes(dayValue);
        });

        currentWords.sort(() => 0.5 - Math.random());
        render();
        document.getElementById('final-submit-area').style.display = currentWords.length > 0 ? 'block' : 'none';
        document.getElementById('overall-feedback').innerText = "";
        document.getElementById('mainSubmitBtn').disabled = false;
        document.getElementById('mainSubmitBtn').innerText = "üé¨ Finish & Submit All";
    }

    function playAudio(word) {
        if (!word || word === '-' || word.toLowerCase() === 'n/a') return;
        const audio = new Audio(`audio/${word.trim().toLowerCase()}.mp3`);
        audio.play().catch(e => console.log("Audio not found: " + word));
    }

    function render() {
        const display = document.getElementById('mainDisplay');
        display.innerHTML = '';
        userAnswers = {};

        currentWords.forEach((item, i) => {
            const typeClass = item.type.toLowerCase() === 'core' ? 'badge-core' : 'badge-elite';
            const wordUpper = item.word.toUpperCase();
            const letters = wordUpper.split('').sort(() => 0.5 - Math.random());

            const card = document.createElement('div');
            card.innerHTML = `
                <div class="vocab-card web-interactive-area" id="card-${i}">
                    <div id="learn-view-${i}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="badge ${typeClass}">${item.type} (Day ${item.day})</span>
                            <div>
                                <button class="btn btn-audio" onclick="playAudio('${item.word}')">üîä Word</button>
                                <button class="btn btn-record" id="rec-${i}" onclick="toggleRecord(${i})">üé§</button>
                                <button class="btn btn-play-rec" id="play-${i}" style="display:none;">‚ñ∂Ô∏è</button>
                            </div>
                        </div>
                        <h2 style="color:var(--core); margin: 10px 0 5px 0; font-size: 2em;">${i+1}. ${item.word}</h2>
                        <div class="def-text">üìñ ${item.def || ''}</div>
                        <p style="margin: 15px 0;"><strong style="color: #f1c40f;">üí° Mnemonic:</strong><br>${item.memory || ''}</p>

                        <div style="display: flex; background: rgba(15, 23, 42, 0.5); border-radius: 8px; padding: 15px; margin-top: 15px; border: 1px solid #334155;">
                            <div style="flex: 1; border-right: 1px solid #4b5563; padding-right: 15px;">
                                <div style="color: var(--core); font-weight: bold; font-size: 0.8em;">üü¢ SYNONYM</div>
                                <div style="font-size: 1.1em; display:flex; align-items:center; gap:5px; flex-wrap:wrap;">
                                    ${item.syn || '-'} 
                                    ${(item.syn && item.syn !== '-' && item.syn.toLowerCase() !== 'n/a') ? `<button class="btn-audio" style="border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;" onclick="playAudio('${item.syn}')">üîä</button>` : ''}
                                </div>
                                <div class="sub-def">${item.syn_def || ''}</div>
                            </div>
                            <div style="flex: 1; padding-left: 15px;">
                                <div style="color: var(--elite); font-weight: bold; font-size: 0.8em;">üî¥ ANTONYM</div>
                                <div style="font-size: 1.1em; display:flex; align-items:center; gap:5px; flex-wrap:wrap;">
                                    ${item.ant || '-'}
                                    ${(item.ant && item.ant !== '-' && item.ant.toLowerCase() !== 'n/a') ? `<button class="btn-audio" style="border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center;" onclick="playAudio('${item.ant}')">üîä</button>` : ''}
                                </div>
                                <div class="sub-def">${item.ant_def || ''}</div>
                            </div>
                        </div>
                    </div>

                    <div id="challenge-view-${i}" style="display: none;">
                        <div class="spell-area">
                            <div class="answer-display" id="ans-${i}"></div>
                            <div class="letter-pool" id="pool-${i}">
                                ${letters.map(l => `<button class="letter-btn" onclick="addLetter(${i}, '${l}', this)">${l}</button>`).join('')}
                            </div>
                            <div class="control-btns" style="margin-top:20px; text-align:center;">
                                <button class="btn" style="background:#e67e22; color:white;" onclick="backspace(${i})">‚¨ÖÔ∏è Back</button>
                            </div>
                            <div id="result-${i}" class="result-box"></div>
                        </div>
                    </div>

                    <button class="btn" id="btn-toggle-${i}" onclick="toggleChallenge(${i})" style="width: 100%; margin-top: 20px; background: var(--primary); color: white;">
                        üéØ Start Challenge (Lock)
                    </button>
                </div>
            `;
            display.appendChild(card);
        });
    }

    function toggleChallenge(i) {
        document.getElementById(`learn-view-${i}`).style.display = 'none';
        document.getElementById(`challenge-view-${i}`).style.display = 'block';
        document.getElementById(`btn-toggle-${i}`).style.display = 'none';
    }

    function addLetter(wordIdx, letter, btn) {
        if(!userAnswers[wordIdx]) userAnswers[wordIdx] = "";
        userAnswers[wordIdx] += letter;
        btn.disabled = true;
        document.getElementById(`ans-${wordIdx}`).innerText = userAnswers[wordIdx];
    }

    function backspace(wordIdx) {
        if(!userAnswers[wordIdx] || userAnswers[wordIdx].length === 0) return;
        const lastLetter = userAnswers[wordIdx].slice(-1);
        userAnswers[wordIdx] = userAnswers[wordIdx].slice(0, -1);
        const pool = document.getElementById(`pool-${wordIdx}`);
        const btns = pool.getElementsByTagName('button');
        for (let btn of btns) {
            if (btn.innerText === lastLetter && btn.disabled) {
                btn.disabled = false;
                break;
            }
        }
        document.getElementById(`ans-${wordIdx}`).innerText = userAnswers[wordIdx];
    }

    async function submitAllAnswers() {
        const studentName = document.getElementById('studentName').value.trim();
        const mainBtn = document.getElementById('mainSubmitBtn');
        mainBtn.disabled = true;
        mainBtn.innerText = "‚è≥ Submitting...";

        let correctCount = 0;

        for (let i = 0; i < currentWords.length; i++) {
            const correctWord = currentWords[i].word.toUpperCase();
            const userAnswer = (userAnswers[i] || "").toUpperCase();
            const isCorrect = (correctWord === userAnswer);
            if(isCorrect) correctCount++;

            const resultDiv = document.getElementById(`result-${i}`);
            resultDiv.style.display = "block";
            
            if(isCorrect) {
                resultDiv.className = "result-box result-correct";
                resultDiv.innerHTML = `<span>üåü Correct! Great memory!</span>`;
            } else {
                resultDiv.className = "result-box result-wrong";
                resultDiv.innerHTML = `
                    <span>üí™ Don't worry, keep practicing! </span><br>
                    <small>Your Answer: <span class="user-ans-label">${userAnswer || '(Empty)'}</span></small>
                    <span class="correct-ans-label">‚ûú Correct: ${correctWord}</span>
                `;
            }

            const pool = document.getElementById(`pool-${i}`);
            const btns = pool.getElementsByTagName('button');
            for(let b of btns) b.disabled = true;

            const payload = {
                student: studentName,
                week: currentWords[i].day,
                correctWord: correctWord,
                userAnswer: userAnswer,
                status: isCorrect ? "‚úÖ Correct" : "‚ùå Incorrect"
            };
            
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }

        const scorePercent = (correctCount / currentWords.length) * 100;
        let message = `You got ${correctCount} / ${currentWords.length} correct! `;
        if(scorePercent === 100) message += "üèÜ Perfect Score! Amazing!";
        else if(scorePercent >= 70) message += "‚ú® Great job!";
        else message += "üìö Keep studying, you're improving!";

        document.getElementById('overall-feedback').innerText = message;
        mainBtn.innerText = "‚úÖ Finished";
    }

    async function toggleRecord(id) {
        const btn = document.getElementById(`rec-${id}`);
        const playBtn = document.getElementById(`play-${id}`);
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
                mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
                audioChunks[id] = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks[id].push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks[id], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    playBtn.style.display = 'inline-block';
                    playBtn.onclick = () => { const audio = new Audio(url); audio.play(); };
                };
                mediaRecorder.start();
                btn.innerText = "üõë Stop";
                btn.style.background = "#ff7675";
            } catch (err) { alert("microphone malfunction"); }
        } else {
            mediaRecorder.stop();
            btn.innerText = "üé§";
            btn.style.background = "#e74c3c";
            mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
    }
</script>

</body>
</html>
