<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathryn 11+ VR Expert Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --core: #55efc4; --elite: #fd79a8; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        /* ä»‹é¢èˆ‡æŒ‰éˆ• */
        .no-print { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #334155; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-right: 5px; transition: 0.3s; }
        .btn-audio { background: #4b5563; color: white; }
        .btn-record { background: #e74c3c; color: white; }
        .btn-play-rec { background: #f1c40f; color: black; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-print { background: #27ae60; color: white; }

        /* ç·´ç¿’å¡ç‰‡ */
        .vocab-card { background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 10px solid var(--primary); }
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
        .badge-core { background: var(--core); color: #000; }
        .badge-elite { background: var(--elite); color: #fff; }

        /* æ¸¬è©¦ç´™æ¨£å¼ (å¹³æ™‚éš±è—ï¼Œåˆ—å°æ™‚é¡¯ç¤º) */
        .test-item { display: none; padding: 20px; border: 1px solid #000; margin-bottom: 25px; page-break-inside: avoid; }
        
        /* åˆ—å°å°ˆç”¨è¨­å®š (é—œéµä¿®å¾©å€) */
        @media print {
            body { background: white !important; color: black !important; }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
            
            /* 1. éš±è—ç¶²é ä»‹é¢å…ƒç´  */
            .no-print, .btn, .web-interactive-area { display: none !important; }
            
            /* 2. å¼·åˆ¶é¡¯ç¤ºæ¸¬è©¦é¡Œç›® (ä½¿ç”¨ !important è¦†è“‹ä»»ä½• JS çš„éš±è—è¨­å®š) */
            .test-item { display: block !important; visibility: visible !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1>ğŸš€ Kathryn 11+ VR ç·´ç¿’ç³»çµ±</h1>
        <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            <label>è¼¸å…¥ Week: </label>
            <input type="number" id="weekInput" value="1" style="width:50px; padding:8px;">
            <button class="btn btn-gen" onclick="generateByWeek()">ğŸ”„ éš¨æ©Ÿç”Ÿæˆæœ¬é€± (7:3)</button>
            
            <button class="btn" style="background:#27ae60; color:white;" onclick="printTest('standard')">ğŸ–¨ï¸ 1. æ¨™æº–å¡«ç©º</button>
            <button class="btn" style="background:#2980b9; color:white;" onclick="printTest('anagram')">ğŸ–¨ï¸ 2. å­—æ¯é‡çµ„</button>
            <button class="btn" style="background:#8e44ad; color:white;" onclick="printTest('hidden')">ğŸ–¨ï¸ 3. éš±è—å­—æŒ‘æˆ°</button>
        </div>
        <p style="font-size: 0.9em; color: #aaa;">* é»æ“Šä¸‹æ–¹ç´«è‰²æŒ‰éˆ• "Start Challenge" å¯é®ä½ç”Ÿå­—é€²è¡Œæ‹¼å­—ç·´ç¿’ã€‚</p>
    </div>

    <div id="mainDisplay"></div>
</div>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathryn 11+ VR Expert Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --core: #55efc4; --elite: #fd79a8; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        /* ä»‹é¢èˆ‡æŒ‰éˆ• */
        .no-print { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #334155; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-right: 5px; transition: 0.3s; }
        .btn-audio { background: #4b5563; color: white; }
        .btn-record { background: #e74c3c; color: white; }
        .btn-play-rec { background: #f1c40f; color: black; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-print { background: #27ae60; color: white; }

        /* ç·´ç¿’å¡ç‰‡ */
        .vocab-card { background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 10px solid var(--primary); }
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
        .badge-core { background: var(--core); color: #000; }
        .badge-elite { background: var(--elite); color: #fff; }

        /* æ¸¬è©¦ç´™æ¨£å¼ (å¹³æ™‚éš±è—ï¼Œåˆ—å°æ™‚é¡¯ç¤º) */
        .test-item { display: none; padding: 20px; border: 1px solid #000; margin-bottom: 25px; page-break-inside: avoid; }
        
        /* åˆ—å°å°ˆç”¨è¨­å®š (é—œéµä¿®å¾©å€) */
        @media print {
            body { background: white !important; color: black !important; }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
            
            /* 1. éš±è—ç¶²é ä»‹é¢å…ƒç´  */
            .no-print, .btn, .web-interactive-area { display: none !important; }
            
            /* 2. å¼·åˆ¶é¡¯ç¤ºæ¸¬è©¦é¡Œç›® (ä½¿ç”¨ !important è¦†è“‹ä»»ä½• JS çš„éš±è—è¨­å®š) */
            .test-item { display: block !important; visibility: visible !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1>ğŸš€ Kathryn 11+ VR ç·´ç¿’ç³»çµ±</h1>
        <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
            <label>è¼¸å…¥ Week: </label>
            <input type="number" id="weekInput" value="1" style="width:50px; padding:8px;">
            <button class="btn btn-gen" onclick="generateByWeek()">ğŸ”„ éš¨æ©Ÿç”Ÿæˆæœ¬é€± (7:3)</button>
            
            <button class="btn" style="background:#27ae60; color:white;" onclick="printTest('standard')">ğŸ–¨ï¸ 1. æ¨™æº–å¡«ç©º</button>
            <button class="btn" style="background:#2980b9; color:white;" onclick="printTest('anagram')">ğŸ–¨ï¸ 2. å­—æ¯é‡çµ„</button>
            <button class="btn" style="background:#8e44ad; color:white;" onclick="printTest('hidden')">ğŸ–¨ï¸ 3. éš±è—å­—æŒ‘æˆ°</button>
        </div>
        <p style="font-size: 0.9em; color: #aaa;">* é»æ“Šä¸‹æ–¹ç´«è‰²æŒ‰éˆ• "Start Challenge" å¯é®ä½ç”Ÿå­—é€²è¡Œæ‹¼å­—ç·´ç¿’ã€‚</p>
    </div>

    <div id="mainDisplay"></div>
</div>

<script>
    let allVocab = [];
    let currentWords = [];
    let mediaRecorder;
    let audioChunks = {};
    let currentTestType = 'standard';

    // 1. åˆå§‹åŒ–èˆ‡æ•¸æ“šåŠ è¼‰
    window.onload = function() {
        // æ ¸å¿ƒä¿®æ­£ï¼šå¼·åˆ¶ç€è¦½å™¨åœ¨èƒŒæ™¯åŠ è¼‰èªéŸ³æ¸…å–®
        if (window.speechSynthesis) {
            window.speechSynthesis.getVoices();
            // ç•¶èªéŸ³æ¸…å–®ç™¼ç”Ÿè®ŠåŒ–æ™‚ï¼Œå†æ¬¡å¼·åˆ¶ç²å–
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
            }
        }

        Papa.parse("vocab.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                allVocab = results.data.filter(row => row.word);
                generateByWeek();
            }
        });
    };

    // 2. éš¨æ©Ÿç”Ÿæˆèˆ‡ 6. æ¸²æŸ“ (ä¿æŒä¸è®Š)
    function generateByWeek() {
        const week = parseInt(document.getElementById('weekInput').value) || 1;
        const cores = allVocab.filter(v => v.type.toUpperCase() === 'CORE');
        const elites = allVocab.filter(v => v.type.toUpperCase() === 'ELITE');
        const seedShuffle = (arr, seed) => {
            let m = arr.length, t, i;
            while (m) {
                i = Math.floor(Math.abs(Math.sin(seed++)) * m--);
                t = arr[m]; arr[m] = arr[i]; arr[i] = t;
            }
            return arr;
        };
        const startC = (week - 1) * 7;
        const startE = (week - 1) * 3;
        let poolC = seedShuffle([...cores], week).slice(startC, startC + 7);
        let poolE = seedShuffle([...elites], week + 50).slice(startE, startE + 3);
        currentWords = seedShuffle([...poolC, ...poolE], week + 99);
        render();
    }

    // â˜…â˜…â˜… 4. ç™¼éŸ³åŠŸèƒ½ ( Daniel èˆ‡ Google UK å„ªå…ˆç‰ˆ) â˜…â˜…â˜…
    function playNative(text) {
        if (!window.speechSynthesis) return;

        // åœæ­¢ä¹‹å‰çš„ç™¼éŸ³
        window.speechSynthesis.cancel();

        // å¼·åˆ¶é‡æ–°æŠ“å–æ¸…å–® (è§£æ±ºé›»è…¦ç‰ˆ/iPadç‰ˆåˆå§‹åŒ–å¤±æ•—å•é¡Œ)
        let voices = window.speechSynthesis.getVoices();

        const msg = new SpeechSynthesisUtterance(text);
        
        // å®šç¾©æ¬Šé‡ï¼šDaniel å’Œ Google UK æ˜¯æœ€é«˜ç­‰ç´š
        const preferredNames = [
            'Daniel',                       // iPad/iPhone é«˜å“è³ªé¦–é¸
            'Google UK English Female',     // é›»è…¦ Chrome é¦–é¸
            'Google UK English Male',       // é›»è…¦ Chrome æ¬¡é¸
            'Microsoft Libby Online',       // Edge é¦–é¸
            'Martha'                        // iOS å‚™é¸
        ];

        let selectedVoice = null;

        // ç¯©é¸é‚è¼¯ï¼šå¿…é ˆæ˜¯è‹±å¼è…”èª¿ï¼Œä¸”æ’é™¤ Compact æ©Ÿå™¨éŸ³
        for (let name of preferredNames) {
            selectedVoice = voices.find(v => 
                v.name.includes(name) && 
                (v.lang.startsWith('en-GB') || v.lang.startsWith('en_GB')) &&
                !v.name.toLowerCase().includes('compact')
            );
            if (selectedVoice) break;
        }

        // å¦‚æœä¸Šè¿°é¦–é¸éƒ½æ²’æ‰¾åˆ° (é€šå¸¸æ˜¯å‰›é–‹ç¶²é è²éŸ³é‚„æ²’è¼‰å…¥)
        if (!selectedVoice) {
            // å˜—è©¦æ‰¾ä»»ä½•é«˜å“è³ªè‹±å¼èªéŸ³
            selectedVoice = voices.find(v => v.lang.startsWith('en-GB') && !v.name.includes('compact'));
        }

        if (selectedVoice) {
            msg.voice = selectedVoice;
            console.log("æˆåŠŸé¸å–èªéŸ³:", selectedVoice.name);
        } else {
            console.log("è­¦å‘Š: å°šæœªæ‰¾åˆ°é¦–é¸èªéŸ³ï¼Œä½¿ç”¨é è¨­å€¼");
        }

        msg.lang = 'en-GB';
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        msg.rate = isIOS ? 0.82 : 0.8; // iPad ç”¨ 0.82 è®€ Daniel æœ€æ¸…æ¥š
        msg.pitch = 1.0;

        window.speechSynthesis.speak(msg);
    }

    // 5. éŒ„éŸ³åŠŸèƒ½èˆ‡ 6. æ¸²æŸ“é‚è¼¯ (èˆ‡æ‚¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸€è‡´ï¼Œç•¥...)
    // [æ­¤è™•è«‹ä¿ç•™æ‚¨åŸæœ¬çš„ render() å’Œ toggleRecord() å‡½æ•¸]
    
    function printTest(type) {
        currentTestType = type;
        render(); 
        setTimeout(() => { window.print(); }, 500);
    }

    async function toggleRecord(id) {
        const btn = document.getElementById(`rec-${id}`);
        const playBtn = document.getElementById(`play-${id}`);
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mimeType = MediaRecorder.isTypeSupported("audio/mp4") ? "audio/mp4" : "audio/webm";
                mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
                audioChunks[id] = [];
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks[id].push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks[id], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    playBtn.style.display = 'inline-block';
                    playBtn.onclick = () => { new Audio(url).play(); };
                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.start();
                btn.innerText = "ğŸ›‘ Stop"; btn.style.background = "#000";
            } catch(e) { alert("éŒ„éŸ³å¤±æ•—ã€‚"); }
        } else {
            mediaRecorder.stop();
            btn.innerText = "ğŸ¤ Re-record"; btn.style.background = "#e74c3c";
        }
    }

    function render() {
        const display = document.getElementById('mainDisplay');
        display.innerHTML = '';
        currentWords.forEach((item, i) => {
            const typeClass = item.type.toLowerCase() === 'core' ? 'badge-core' : 'badge-elite';
            const word = item.word.toUpperCase(); 
            const displayWord = item.word; 
            const anagram = word.split('').sort(() => 0.5 - Math.random()).join(' ');
            const sentence = `The boy sa${word.slice(0,2).toLowerCase()} i${word.slice(2).toLowerCase()} it was great.`.replace("  ", " ");
            const card = document.createElement('div');
            card.innerHTML = `
                <div class="vocab-card word-info web-interactive-area">
                    <div id="learn-view-${i}">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="badge ${typeClass}">${item.type}</span>
                            <div>
                                <button class="btn btn-audio" onclick="playNative('${displayWord}')">ğŸ”Š Voice</button>
                                <button class="btn btn-record" id="rec-${i}" onclick="toggleRecord(${i})">ğŸ¤</button>
                                <button class="btn btn-play-rec" id="play-${i}" style="display:none;">â–¶ï¸</button>
                            </div>
                        </div>
                        <h2 style="color:var(--core); margin: 10px 0;">${i+1}. ${displayWord}</h2>
                        <p style="margin-bottom: 15px;">
                            <strong style="color: #f1c40f;">ğŸ’¡ Mnemonic:</strong><br>
                            <span style="font-size: 1.1em;">${item.memory}</span>
                        </p>
                        <div style="display: flex; gap: 30px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                            <div><span style="color: #55efc4; font-weight: bold;">ğŸŸ¢ SYNONYM</span><br><span style="font-size: 1.2em;">${item.syn}</span></div>
                            <div style="border-left: 1px solid #444; padding-left: 30px;"><span style="color: #ff7675; font-weight: bold;">ğŸ”´ ANTONYM</span><br><span style="font-size: 1.2em;">${item.ant}</span></div>
                        </div>
                    </div>
                    <div id="challenge-view-${i}" style="display: none; text-align: center; padding: 20px 0;">
                        <strong style="color: var(--elite); font-size: 1.2em;">ğŸ§© 11+ VR Challenge (Anagram):</strong>
                        <div style="background: #000; padding: 15px; border-radius: 8px; margin: 10px 0; border: 2px dashed #666;">
                            <span style="font-family: monospace; font-size: 2em; letter-spacing: 5px; color: white;">${anagram}</span>
                        </div>
                    </div>
                    <button class="btn" id="btn-toggle-${i}" onclick="toggleChallenge(${i})" style="width: 100%; margin-top: 20px; background: var(--primary);">ğŸ¯ Start Challenge (Hide Word)</button>
                </div>
                <div class="test-item">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #000; padding-bottom:5px; margin-bottom:10px;">
                        <span>11+ VR Test: Week ${document.getElementById('weekInput').value}</span>
                        <span>Mode: ${currentTestType.toUpperCase()}</span>
                    </div>
                    ${currentTestType === 'standard' ? `<p><b>Q${i+1}:</b> Find a synonym of "${item.syn}" and antonym of "${item.ant}".</p><p style="font-size: 1.4em; font-family: monospace; font-weight: bold; margin: 15px 0;">${word.charAt(0)} ${"_ ".repeat(word.length - 2)} ${word.slice(-1)} (${word.length} letters)</p>` : ''}
                    ${currentTestType === 'anagram' ? `<p><b>Q${i+1}:</b> Rearrange these letters to form a word that means "${item.syn}":</p><p style="font-size: 1.4em; font-weight: bold; letter-spacing: 3px; margin: 15px 0;">${anagram}</p><p>Answer: ___________________________</p>` : ''}
                    ${currentTestType === 'hidden' ? `<p><b>Q${i+1}:</b> A ${word.length}-letter word is hidden in: "${sentence}"</p><p>Hidden Word: ___________________________</p>` : ''}
                </div>
            `;
            display.appendChild(card);
        });
    }

    function toggleChallenge(i) {
        const lv = document.getElementById(`learn-view-${i}`);
        const cv = document.getElementById(`challenge-view-${i}`);
        const btn = document.getElementById(`btn-toggle-${i}`);
        if (lv.style.display !== 'none') {
            lv.style.display = 'none'; cv.style.display = 'block';
            btn.innerText = 'ğŸ‘ï¸ Show Word (Peek)'; btn.style.background = '#4b5563';
        } else {
            lv.style.display = 'block'; cv.style.display = 'none';
            btn.innerText = 'ğŸ¯ Start Challenge (Hide Word)'; btn.style.background = '#6c5ce7';
        }
    }
</script>

</body>
</html>


</body>
</html>
