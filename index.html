<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kathryn 11+ VR Expert Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --core: #55efc4; --elite: #fd79a8; --bg: #0f172a; --card-bg: #1e293b; --text: #f8fafc; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        /* ä»‹é¢èˆ‡æŒ‰éˆ• */
        .no-print { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #334155; }
        .btn { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-right: 5px; transition: 0.3s; }
        .btn-audio { background: #4b5563; color: white; }
        .btn-record { background: #e74c3c; color: white; }
        .btn-play-rec { background: #f1c40f; color: black; }
        .btn-gen { background: var(--primary); color: white; }
        .btn-print { background: #27ae60; color: white; }

        /* ç·´ç¿’å¡ç‰‡ */
        .vocab-card { background: var(--card-bg); padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 10px solid var(--primary); }
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold; }
        .badge-core { background: var(--core); color: #000; }
        .badge-elite { background: var(--elite); color: #fff; }

        /* VR ç·´ç¿’å€ */
        .vr-practice-zone { background: #2d3436; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px dashed #636e72; }
        
        /* æ¸¬è©¦ç´™æ¨£å¼ (VR é¡Œå‹) */
        .test-item { display: none; padding: 20px; border: 1px solid #000; margin-bottom: 25px; page-break-inside: avoid; }
        
       @media print {
            body { background: white !important; color: black !important; }
            /* éš±è—ç¶²é ä¸Šçš„æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•ã€èªéŸ³å€å¡Šå’ŒæŒ‘æˆ°åˆ‡æ›å€ */
            .no-print, .word-info, [id^="content-"], [id^="challenge-"], [id^="btn-toggle-"], .btn { 
                display: none !important; 
            }
            /* å¼·åˆ¶é¡¯ç¤ºæ¸¬è©¦é¡Œç›® */
            .test-item { 
                display: block !important; 
                visibility: visible !important;
                page-break-inside: avoid;
            }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1>ğŸš€ Kathryn 11+ VR ç·´ç¿’ç³»çµ±</h1>
        <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
        <label>è¼¸å…¥ Week: </label>
        <input type="number" id="weekInput" value="1" style="width:50px; padding:8px;">
        <button class="btn btn-gen" onclick="generateByWeek()">ğŸ”„ éš¨æ©Ÿç”Ÿæˆæœ¬é€± (7:3)</button>
        
        <button class="btn" style="background:#27ae60; color:white;" onclick="printTest('standard')">ğŸ–¨ï¸ 1. æ¨™æº–å¡«ç©º</button>
        <button class="btn" style="background:#2980b9; color:white;" onclick="printTest('anagram')">ğŸ–¨ï¸ 2. å­—æ¯é‡çµ„</button>
        <button class="btn" style="background:#8e44ad; color:white;" onclick="printTest('hidden')">ğŸ–¨ï¸ 3. éš±è—å­—æŒ‘æˆ°</button>
    </div>
    <p style="font-size: 0.9em; color: #aaa;">* ç·´ç¿’æ¨¡å¼åœ¨ç¶²é é¡¯ç¤ºï¼›åˆ—å°æ™‚æœƒæ ¹æ“šæ‚¨é»æ“Šçš„æŒ‰éˆ•è‡ªå‹•åˆ‡æ›è€ƒæ³•ã€‚</p>
</div>

    <div id="mainDisplay"></div>
</div>

<script>
    let allVocab = [];
    let currentWords = [];
    let mediaRecorder;
    let audioChunks = {};
    let currentTestType = 'standard';

    window.onload = function() {
        Papa.parse("vocab.csv", {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                allVocab = results.data.filter(row => row.word);
                generateByWeek();
            }
        });
    };

    function printTest(type) {
        currentTestType = type;
        render(); 
        setTimeout(() => { window.print(); }, 300);
    }

    function generateByWeek() {
        const week = parseInt(document.getElementById('weekInput').value) || 1;
        const cores = allVocab.filter(v => v.type.toUpperCase() === 'CORE');
        const elites = allVocab.filter(v => v.type.toUpperCase() === 'ELITE');
        const seedShuffle = (arr, seed) => {
            let m = arr.length, t, i;
            while (m) {
                i = Math.floor(Math.abs(Math.sin(seed++)) * m--);
                t = arr[m]; arr[m] = arr[i]; arr[i] = t;
            }
            return arr;
        };
        const startC = (week - 1) * 7;
        const startE = (week - 1) * 3;
        let poolC = seedShuffle([...cores], week).slice(startC, startC + 7);
        let poolE = seedShuffle([...elites], week + 50).slice(startE, startE + 3);
        currentWords = seedShuffle([...poolC, ...poolE], week + 99);
        render();
    }

    function playNative(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.name === 'Google UK English Female') || voices.find(v => v.lang === 'en-GB');
        if (preferredVoice) msg.voice = preferredVoice;
        msg.lang = 'en-GB';
        msg.rate = 0.75;
        window.speechSynthesis.speak(msg);
    }

    async function toggleRecord(id) {
        const btn = document.getElementById(`rec-${id}`);
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks[id] = [];
            mediaRecorder.ondataavailable = e => audioChunks[id].push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks[id], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                document.getElementById(`play-${id}`).style.display = 'inline-block';
                document.getElementById(`play-${id}`).onclick = () => new Audio(url).play();
            };
            mediaRecorder.start();
            btn.innerText = "ğŸ›‘ Stop..."; btn.style.background = "#000";
        } else {
            mediaRecorder.stop();
            btn.innerText = "ğŸ¤ Re-record"; btn.style.background = "#e74c3c";
        }
    }

    // 5. æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ (åŠ å…¥éš±è—æŒ‘æˆ°æ¨¡å¼)
    function render() {
        const display = document.getElementById('mainDisplay');
        display.innerHTML = '';

        currentWords.forEach((item, i) => {
            const word = item.word;
            const anagram = word.toUpperCase().split('').sort(() => 0.5 - Math.random()).join(' ');
            const sentence = `The boy sa${word.slice(0,2).toLowerCase()} i${word.slice(2).toLowerCase()} it was great.`;

            const card = document.createElement('div');
            // æ³¨æ„ï¼šé€™è£¡ä¸è¦çµ¦å¤–å±¤ card åŠ éš±è—å±¬æ€§
            card.innerHTML = `
                <div class="word-info-container"> 
                    <div id="content-${i}">
                        <h2 style="color:var(--core);">${i+1}. ${word}</h2>
                        <p><strong>ğŸ’¡ Mnemonic:</strong> ${item.memory}</p>
                        </div>

                    <div id="challenge-${i}" style="display: none;">
                        </div>

                    <button class="btn" id="btn-toggle-${i}" onclick="toggleChallenge(${i})">ğŸ¯ Start Challenge</button>
                </div>

                <div class="test-item">
                    <div style="border-bottom:1px solid #000; margin-bottom:10px;">
                        11+ VR Test - Week ${document.getElementById('weekInput').value} | Mode: ${currentTestType.toUpperCase()}
                    </div>
                    ${currentTestType === 'standard' ? `
                        <p><b>Q${i+1}:</b> Find a synonym of "${item.syn}" and antonym of "${item.ant}".</p>
                        <p style="font-size:1.4em; font-family:monospace;">${word.charAt(0).toUpperCase()} ${"_ ".repeat(word.length-2)} ${word.slice(-1).toUpperCase()} (${word.length} letters)</p>
                    ` : ''}
                    ${currentTestType === 'anagram' ? `
                        <p><b>Q${i+1}:</b> Rearrange these letters to form a word that means "${item.syn}":</p>
                        <p style="font-size:1.4em; letter-spacing:5px;">${anagram}</p>
                    ` : ''}
                    ${currentTestType === 'hidden' ? `
                        <p><b>Q${i+1}:</b> A ${word.length}-letter word is hidden here: "${sentence}"</p>
                    ` : ''}
                </div>
            `;
            display.appendChild(card);
        });
    }

    // 6. æŒ‘æˆ°åˆ‡æ›é‚è¼¯
    function toggleChallenge(id) {
        const content = document.getElementById(`content-${id}`);
        const challenge = document.getElementById(`challenge-${id}`);
        const btn = document.getElementById(`btn-toggle-${id}`);

        if (content.style.display !== "none") {
            content.style.display = "none";
            challenge.style.display = "block";
            btn.innerText = "ğŸ‘ï¸ Show Word (Peek)";
            btn.style.background = "#4b5563";
        } else {
            content.style.display = "block";
            challenge.style.display = "none";
            btn.innerText = "ğŸ¯ Start Anagram Challenge";
            btn.style.background = "#6c5ce7";
        }
    }
    
    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
</script>

</body>
</html>
